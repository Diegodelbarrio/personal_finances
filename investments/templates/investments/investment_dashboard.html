{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h1 class="fw-bold mb-0">My Portfolio</h1>
            <p class="text-muted">Performance analysis and asset distribution</p>
        </div>
        <span class="badge bg-light text-dark border rounded-pill px-3 py-2">
            <i class="bi bi-clock-history me-2"></i>
            {% if last_market_date %}
                {{ last_market_date|date:"d/m/Y" }}
            {% else %}
                No data
            {% endif %}
        </span>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card card-rounded border-0 shadow-sm p-4 h-100 bg-dark text-white">
                <small class="text-uppercase opacity-75 fw-bold letter-spacing">Global Market Value</small>
                <h1 class="display-5 fw-bold mt-2 mb-0">{{ global_current_value|floatformat:2 }}€</h1>
                <div class="mt-4">
                    <span class="badge {% if global_roi >= 0 %}bg-success{% else %}bg-danger{% endif %} rounded-pill px-3 py-2">
                        {{ global_roi|floatformat:2 }}% Total ROI
                    </span>
                </div>
            </div>
        </div>

        <div class="col-md-4" style="text-align: center;">
            <div class="card card-rounded border-0 shadow-sm p-4 h-100 bg-white">
                <div class="mb-4">
                    <small class="text-uppercase text-muted fw-bold letter-spacing">Global Invested</small>
                    <h3 class="fw-bold mb-0 text-dark">{{ global_invested|floatformat:2 }}€</h3>
                </div>
                <div class="pt-3 border-top">
                    <small class="text-uppercase text-muted fw-bold letter-spacing">Global Profit / Loss</small>
                    <h3 class="fw-bold mb-0 {% if global_profit_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ global_profit_loss|floatformat:2 }}€
                    </h3>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-rounded border-0 shadow-sm p-4 h-100 bg-light
                        d-flex flex-column justify-content-center align-items-center">

                <small class="text-uppercase text-muted fw-bold letter-spacing">
                    Global Assets
                </small>

                <h2 class="fw-bold mt-2" style="font-size: 2.5rem;">
                    {{ portfolio|length }}
                </h2>

                <p class="small text-muted mb-0 text-center">
                    Total Active assets in Portfolio
                </p>
            </div>
        </div>

    </div>
    {% if user.is_superuser %}
    <div class="d-flex align-items-center mb-4 mt-4">
        <hr class="flex-grow-1 opacity-10">
        <span class="mx-3 text-muted small fw-bold text-uppercase letter-spacing" style="white-space: nowrap;">
            <i class="bi bi-person-badge me-1"></i> Personal Breakdown (Excluding Family Investments)
        </span>
        <hr class="flex-grow-1 opacity-10">
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card card-rounded border-0 shadow-sm p-4 h-100 bg-primary text-white bg-gradient">
                <small class="text-uppercase opacity-75 fw-bold letter-spacing">Personal Market Value</small>
                <h1 class="display-5 fw-bold mt-2 mb-0">{{ no_family_value|floatformat:2 }}€</h1>
                
                <div class="mt-4">
                    <span class="badge {% if no_family_roi >= 0 %}bg-success{% else %}bg-danger{% endif %} rounded-pill px-3 py-2">
                        {{ no_family_roi|floatformat:2 }}% Personal ROI
                    </span>
                </div>
            </div>
        </div>

        <div class="col-md-4" style="text-align: center;">
            <div class="card card-rounded border-0 shadow-sm p-4 h-100 bg-white">
                <div class="mb-3">
                    <small class="text-uppercase text-muted fw-bold letter-spacing">Personal Invested</small>
                    <h4 class="fw-bold mb-0 text-dark">{{ no_family_invested|floatformat:2 }}€</h4>
                </div>
                <div class="pt-3 border-top">
                    <small class="text-uppercase text-muted fw-bold letter-spacing">Personal P/L</small>
                    <h4 class="fw-bold mb-0 {% if no_family_profit_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ no_family_profit_loss|floatformat:2 }}€
                    </h4>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-rounded border-0 shadow-sm p-4 h-100 bg-light
                        d-flex flex-column justify-content-center align-items-center">

                <small class="text-uppercase text-muted fw-bold letter-spacing">
                    Global Assets
                </small>

                <h2 class="fw-bold mt-2" style="font-size: 2.5rem;">
                    {{ portfolio|length|add:"-1" }}
                </h2>

                <p class="small text-muted mb-0 text-center">
                    Active assets excluding: Family Investments
                </p>
            </div>
        </div>

    </div>
    {% endif %}

    <div class="card card-rounded border-0 shadow-sm overflow-hidden mb-3">
        <div class="card-header bg-white py-4 border-0 px-4 d-flex justify-content-between align-items-center">
            <h5 class="fw-bold mb-0">Asset Breakdown</h5>
            <div id="searchContainer" class="ms-auto"></div>
        </div>

        <div class="table-responsive px-2 pb-3">
            <table id="portfolioTable" class="table align-middle mb-0 table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th class="ps-3">Asset</th>
                        <th>Category</th>
                        <th class="text-end">Allocation</th>
                        <th class="text-end">Invested</th>
                        <th class="text-end">Market Value</th>
                        <th class="text-end">P/L</th>
                        <th class="text-end pe-3">ROI</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in portfolio %}
                    <tr {% if item.obj.name == 'Family Investment' %}class="table-light opacity-75"{% endif %}>
                        <td class="ps-3">
                            <div class="d-flex align-items-center">
                                <div class="icon-shape rounded-circle bg-light me-3 d-flex align-items-center justify-content-center">
                                    {% if item.obj.category == 'CRYPTO' %}
                                        <i class="bi bi-currency-bitcoin text-warning"></i>
                                    {% elif item.obj.category == 'INDEX_FUND' %}
                                        <i class="bi bi-graph-up-arrow text-primary"></i>
                                    {% elif item.obj.category == 'COMMODITY' %}
                                        <i class="bi bi-gem text-danger"></i>
                                    {% else %}
                                        <i class="bi bi-layers text-secondary"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <span class="fw-bold d-block">{{ item.obj.name }}</span>
                                    <small class="text-muted small">{{ item.obj.platform }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border-0 fw-normal rounded-pill px-3">
                                {{ item.obj.get_category_display }}
                            </span>
                        </td>
                        <td class="text-end">
                            <div class="d-flex justify-content-end align-items-center">
                                <span class="me-2 small fw-bold">{{ item.allocation_display }}%</span>
                                <div class="progress" style="height:6px; width:60px;">
                                    <div class="progress-bar bg-primary rounded-pill" data-width="{{ item.allocation_css }}"></div>
                                </div>
                            </div>
                        </td>
                        <td class="text-end" data-order="{{ item.invested }}">
                            <span class="text-muted small">{{ item.invested|floatformat:2 }}€</span>
                        </td>
                        <td class="text-end fw-bold" data-order="{{ item.current_value }}">
                            {{ item.current_value|floatformat:2 }}€
                        </td>
                        <td class="text-end fw-bold {% if item.profit_loss >= 0 %}text-success{% else %}text-danger{% endif %}" data-order="{{ item.profit_loss }}">
                            {{ item.profit_loss|floatformat:2 }}€
                        </td>
                        <td class="text-end pe-3" data-order="{{ item.roi }}">
                            <span class="badge {% if item.roi >= 0 %}bg-success-subtle text-success{% else %}bg-danger-subtle text-danger{% endif %} rounded-pill px-3">
                                {{ item.roi|floatformat:2 }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

   <div class="row g-4 mt-0">
        <div class="col-12 col-lg-6">
            <div class="card card-rounded border-0 shadow-sm p-4 h-100 bg-white">
                <div class="d-flex justify-content-between align-items-center mb-5">
                    <div>
                        <h6 class="fw-bold text-muted mb-0">Performance History (Personal)</h6>
                        <small class="text-muted small">Excluding Family Investments</small>
                    </div>
                    <span class="badge bg-primary-subtle text-primary rounded-pill px-3">
                        Personal ROI Focus
                    </span>
                </div>
                <div style="height: 250px;">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>

<div class="col-12 col-lg-6">
    <div class="card card-rounded border-0 shadow-sm p-4 h-100 bg-white">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h6 class="fw-bold text-muted mb-0">Asset Allocation</h6>
                <small class="text-muted small">Current value distribution</small>
            </div>
            <span class="badge bg-primary-subtle text-primary rounded-pill px-3">
                Personal Investments Focus
            </span>
        </div>
        
        <div class="row align-items-center">
            <div class="col-sm-6">
                <div style="height: 290px;">
                    <canvas id="allocationChart"></canvas>
                </div>
            </div>
            <div class="col-sm-5">
                <div id="allocationLegend" style="max-height: 290px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>

    <div class="row g-4 mt-2">
        <div class="col-12 col-lg-6">
            <div class="card card-rounded border-0 shadow-sm p-4 h-100 bg-white">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h6 class="fw-bold text-muted mb-0">Monthly Contributions</h6>
                        <small class="text-muted small">Stacked by asset (Excl. Family)</small>
                    </div>
                    <i class="bi bi-bar-chart-steps text-primary opacity-50"></i>
                </div>
                <div style="height: 300px;">
                    <canvas id="monthlyContributionsChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card card-rounded border-2 border-dashed shadow-none p-4 h-100 d-flex align-items-center justify-content-center bg-light opacity-75" style="border: 2px dashed #cbd5e1 !important;">
                <div class="text-center">
                    <div class="icon-box bg-white shadow-sm mx-auto mb-3 d-flex align-items-center justify-content-center rounded-circle" style="width: 60px; height: 60px;">
                        <i class="bi bi-rocket-takeoff text-muted fs-4"></i>
                    </div>
                    <h6 class="fw-bold text-muted mb-1">Advanced Analytics</h6>
                    <p class="small text-muted mb-0">Coming Soon: AI-driven projections and dividend tracking.</p>
                </div>
            </div>
        </div>
    </div>

{{ performance_history|json_script:"performance-data" }}
{{ allocation_labels|json_script:"allocation-labels" }}
{{ allocation_data|json_script:"allocation-data" }}
{{ bar_labels|json_script:"bar-labels" }}
{{ bar_datasets|json_script:"bar-datasets" }}

<style>
    .card-rounded { border-radius: 1.5rem; }
    .letter-spacing { letter-spacing: 1px; font-size: 0.7rem; }
    .icon-shape { width: 38px; height: 38px; font-size: 1.2rem; min-width: 38px; }
    .bg-success-subtle { background-color: #e8f5e9 !important; }
    .bg-danger-subtle { background-color: #ffebee !important; }
    .bg-primary-subtle { background-color: #e0e7ff !important; }
    .table thead th { border: none; font-size: 0.65rem; text-transform: uppercase; color: #999; padding-bottom: 15px; }
    .dataTables_filter { margin: 0 !important; }
    .dataTables_filter input { border-radius: 50px; border: 1px solid #eee; padding: 6px 15px; font-size: 0.85rem; width: 220px; outline: none; }
</style>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
$(document).ready(function () {
    const table = $('#portfolioTable').DataTable({
        pageLength: 25, order: [[4, 'desc']],
        language: { search: "", searchPlaceholder: "Search asset..." },
        dom: '<"d-flex justify-content-between align-items-center mb-3"f>rt<"d-flex justify-content-between align-items-center p-3"ip>'
    });
    $('#searchContainer').append($('.dataTables_filter'));

    document.querySelectorAll('.progress-bar').forEach(bar => { bar.style.width = bar.dataset.width; });

    const perfData = JSON.parse(document.getElementById('performance-data').textContent);

    if (perfData.length > 0) {
        new Chart(document.getElementById('performanceChart'), {
            type: 'line',
            data: {
                labels: perfData.map(d => d.label),
                datasets: [
                    {
                        label: 'Personal Market Value',
                        data: perfData.map(d => d.market),
                        borderColor: '#0d6efd', /* Azul para diferenciar del verde global anterior */
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 2
                    },
                    {
                        label: 'Personal Invested',
                        data: perfData.map(d => d.invested),
                        borderColor: '#adb5bd',
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0,
                        borderWidth: 2,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { 
                    legend: { display: true, position: 'bottom' } 
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { 
                        beginAtZero: true,
                        ticks: { callback: v => v.toLocaleString('de-DE') + ' €' } 
                    }
                }
            }
        });
    }

    // === GRÁFICO DE ASSET ALLOCATION ===
const allocLabels = JSON.parse(document.getElementById('allocation-labels').textContent);
const allocValues = JSON.parse(document.getElementById('allocation-data').textContent);

if (allocValues.length > 0) {
    const allocPalette = ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#fd7e14', '#ffc107', '#198754', '#0dcaf0'];
    const totalAlloc = allocValues.reduce((a, b) => a + b, 0);

    const ctxAlloc = document.getElementById('allocationChart').getContext('2d');
    const allocationChart = new Chart(ctxAlloc, {
        type: 'doughnut',
        data: {
            labels: allocLabels,
            datasets: [{
                data: allocValues,
                backgroundColor: allocPalette,
                borderWidth: 1,
                borderColor: '#ffffff',
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '50%',
            layout: {
                padding: 20 
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        // Personalizamos para que NO repita el label (nombre) si ya sale en el título
                        label: function(context) {
                            let val = context.raw.toLocaleString('de-DE', { minimumFractionDigits: 2 });
                            let pct = ((context.raw / totalAlloc) * 100).toFixed(1);
                            return ` ${val} € (${pct}%)`; 
                        }
                    }
                }
            }
        }
    });

    // Generar Leyenda dinámica con disposición de doble línea
    const allocLegend = document.getElementById('allocationLegend');
    allocLegend.innerHTML = ''; 

    allocLabels.forEach((label, i) => {
        const val = allocValues[i];
        const pct = totalAlloc > 0 ? ((val / totalAlloc) * 100).toFixed(1) : 0;
        const color = allocPalette[i % allocPalette.length];
        
        const item = document.createElement('div');
        item.className = 'mb-3 px-2 py-1 rounded-3'; 
        item.style.cursor = 'pointer';
        item.style.transition = 'all 0.2s ease';
        
        item.innerHTML = `
            <div class="d-flex align-items-center mb-1">
                <div style="width:8px; height:8px; border-radius:50%; background:${color}; flex-shrink:0;"></div>
                <span class="small fw-bold ms-2 text-dark" style="font-size: 0.75rem;">${label}</span>
            </div>
            <div class="ps-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="text-muted" style="font-size: 0.7rem;">${val.toLocaleString('de-DE', { minimumFractionDigits: 2 })} €</span>
                    <span class="fw-bold text-primary" style="font-size: 0.75rem;">${pct}%</span>
                </div>
                <div class="progress" style="height: 3px; background-color: #f1f5f9;">
                    <div class="progress-bar" style="width: ${pct}%; background-color: ${color}"></div>
                </div>
            </div>
        `;
        
        item.onmouseenter = () => {
            item.style.backgroundColor = '#f1f5f9';
            allocationChart.setActiveElements([{ datasetIndex: 0, index: i }]);
            allocationChart.tooltip.setActiveElements([{ datasetIndex: 0, index: i }], { x: 0, y: 0 });
            allocationChart.update();
        };
        item.onmouseleave = () => {
            item.style.backgroundColor = 'transparent';
            allocationChart.setActiveElements([]);
            allocationChart.update();
        };
        
        allocLegend.appendChild(item);
    });
}
// === GRÁFICO DE APORTACIONES MENSUALES (Stacked Bar) ===
    const barLabels = JSON.parse(document.getElementById('bar-labels').textContent);
    const barDatasetsRaw = JSON.parse(document.getElementById('bar-datasets').textContent);
    const palette = ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#fd7e14', '#ffc107', '#198754', '#0dcaf0'];

    if (barLabels.length > 0) {
        const barDatasets = barDatasetsRaw.map((ds, i) => ({
            label: ds.label,
            data: ds.data,
            backgroundColor: palette[i % palette.length],
            borderRadius: 0,
            borderSkipped: false,
        }));

        new Chart(document.getElementById('monthlyContributionsChart'), {
            type: 'bar',
            data: {
                labels: barLabels,
                datasets: barDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true, 
                        position: 'bottom', 
                        labels: { boxWidth: 12, usePointStyle: true, font: { size: 10 } } 
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            // AQUÍ SE AÑADE EL SÍMBOLO DEL EURO EN EL HOVER
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('de-DE', { 
                                        style: 'currency', 
                                        currency: 'EUR' 
                                    }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: { stacked: true, grid: { display: false } },
                    y: { 
                        stacked: true, 
                        beginAtZero: true,
                        ticks: { 
                            callback: v => v.toLocaleString('de-DE') + ' €' 
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}