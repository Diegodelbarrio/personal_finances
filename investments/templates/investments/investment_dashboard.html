{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h1 class="fw-bold mb-0">My Portfolio</h1>
            <p class="text-muted">Performance analysis and asset distribution</p>
        </div>
        <span class="badge bg-light text-dark border rounded-pill px-3 py-2">
            <i class="bi bi-clock-history me-2"></i>
            {% if last_market_date %}
                {{ last_market_date|date:"d/m/Y" }}
            {% else %}
                No data
            {% endif %}
        </span>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card card-rounded border-0 shadow-sm p-4 h-100 bg-dark text-white">
                <small class="text-uppercase opacity-75 fw-bold letter-spacing">Market Value</small>
                <h1 class="display-5 fw-bold mt-2 mb-0">{{ global_current_value|floatformat:2 }}€</h1>
                <div class="mt-4">
                    <span class="badge {% if global_roi >= 0 %}bg-success{% else %}bg-danger{% endif %} rounded-pill px-3 py-2">
                        {{ global_roi|floatformat:2 }}% Total ROI
                    </span>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-rounded border-0 shadow-sm p-4 h-100 bg-white">
                <div class="mb-4">
                    <small class="text-uppercase text-muted fw-bold letter-spacing">Total Invested</small>
                    <h3 class="fw-bold mb-0 text-dark">{{ global_invested|floatformat:2 }}€</h3>
                </div>
                <div class="pt-3 border-top">
                    <small class="text-uppercase text-muted fw-bold letter-spacing">Profit / Loss</small>
                    <h3 class="fw-bold mb-0 {% if global_profit_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ global_profit_loss|floatformat:2 }}€
                    </h3>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-rounded border-0 shadow-sm p-4 h-100 bg-primary text-white bg-gradient">
                <small class="text-uppercase opacity-75 fw-bold letter-spacing">Total Assets</small>
                <h1 class="display-6 fw-bold mt-2">{{ portfolio|length }}</h1>
                <p class="small opacity-75 mb-4">Active diversification in portfolio.</p>
                <a href="/admin/investments/transaction/add/" class="btn btn-sm btn-light rounded-pill px-3 mt-auto w-50">
                    <i class="bi bi-plus-lg me-1"></i> Add New
                </a>
            </div>
        </div>
    </div>

    <div class="card card-rounded border-0 shadow-sm overflow-hidden">
        <div class="card-header bg-white py-4 border-0 px-4 d-flex justify-content-between align-items-center">
            <h5 class="fw-bold mb-0">Asset Breakdown</h5>
            <div id="searchContainer" class="ms-auto"></div>
        </div>

        <div class="table-responsive px-2 pb-3">
            <table id="portfolioTable" class="table align-middle mb-0 table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th class="ps-3">Asset</th>
                        <th>Category</th>
                        <th class="text-end">Allocation</th>
                        <th class="text-end">Invested</th>
                        <th class="text-end">Market Value</th>
                        <th class="text-end">P/L</th>
                        <th class="text-end pe-3">ROI</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in portfolio %}
                    <tr>
                        <td class="ps-3">
                            <div class="d-flex align-items-center">
                                <div class="icon-shape rounded-circle bg-light me-3 d-flex align-items-center justify-content-center">
                                    {% if item.obj.category == 'CRYPTO' %}
                                        <i class="bi bi-currency-bitcoin text-warning"></i>
                                    {% elif item.obj.category == 'INDEX_FUND' %}
                                        <i class="bi bi-graph-up-arrow text-primary"></i>
                                    {% elif item.obj.category == 'COMMODITY' %}
                                        <i class="bi bi-gem text-danger"></i>
                                    {% else %}
                                        <i class="bi bi-layers text-secondary"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <span class="fw-bold d-block">{{ item.obj.name }}</span>
                                    <small class="text-muted small">{{ item.obj.platform }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border-0 fw-normal rounded-pill px-3">
                                {{ item.obj.get_category_display }}
                            </span>
                        </td>
                        <td class="text-end">
                            <div class="d-flex justify-content-end align-items-center">
                                <span class="me-2 small fw-bold">{{ item.allocation_display }}%</span>
                                <div class="progress" style="height:6px; width:60px;">
                                    <div class="progress-bar bg-primary rounded-pill"
                                         data-width="{{ item.allocation_css }}">
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-end" data-order="{{ item.invested }}">
                            <span class="text-muted small">{{ item.invested|floatformat:2 }}€</span>
                        </td>
                        <td class="text-end fw-bold" data-order="{{ item.current_value }}">
                            {{ item.current_value|floatformat:2 }}€
                        </td>
                        <td class="text-end fw-bold {% if item.profit_loss >= 0 %}text-success{% else %}text-danger{% endif %}" data-order="{{ item.profit_loss }}">
                            {{ item.profit_loss|floatformat:2 }}€
                        </td>
                        <td class="text-end pe-3" data-order="{{ item.roi }}">
                            <span class="badge {% if item.roi >= 0 %}bg-success-subtle text-success{% else %}bg-danger-subtle text-danger{% endif %} rounded-pill px-3">
                                {{ item.roi|floatformat:2 }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .card-rounded { border-radius: 1.5rem; }
    .letter-spacing { letter-spacing: 1px; font-size: 0.7rem; }
    .icon-shape { width: 38px; height: 38px; font-size: 1.2rem; min-width: 38px; }
    .bg-success-subtle { background-color: #e8f5e9 !important; }
    .bg-danger-subtle { background-color: #ffebee !important; }

    .table thead th {
        border: none;
        font-size: 0.65rem;
        text-transform: uppercase;
        color: #999;
        padding-bottom: 15px;
    }

    .dataTables_filter { margin: 0 !important; }
    .dataTables_filter input {
        border-radius: 50px;
        border: 1px solid #eee;
        padding: 6px 15px;
        font-size: 0.85rem;
        width: 220px;
        outline: none;
    }
</style>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function () {

    // DataTable
    const table = $('#portfolioTable').DataTable({
        pageLength: 25,
        order: [[4, 'desc']],
        language: {
            search: "",
            searchPlaceholder: "Search asset..."
        },
        dom: '<"d-flex justify-content-between align-items-center mb-3"f>rt<"d-flex justify-content-between align-items-center p-3"ip>'
    });

    $('#searchContainer').append($('.dataTables_filter'));

    // Progress bars (NO inline CSS → no red errors)
    document.querySelectorAll('.progress-bar').forEach(bar => {
        bar.style.width = bar.dataset.width;
    });
});
</script>
{% endblock %}
